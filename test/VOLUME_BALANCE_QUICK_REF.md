# 音量均衡功能 - 快速参考

## 一句话说明
自动调整所有视频片段的音量，使它们保持一致，避免某些片段声音过大或过小。

## 如何使用

### 快速开始
1. ✅ 勾选"启用音量均衡"
2. ✅ 选择策略（推荐"平均值"）
3. ✅ 点击"开始生成"

### 策略选择

| 策略 | 适用场景 | 优点 |
|------|---------|------|
| **平均值** | 大部分情况 | 简单直观 |
| **中位数** | 有异常片段 | 不受极端值影响 |
| **固定值** | 需要特定标准 | 完全可控 |

### 目标音量设置（固定值策略）

| 用途 | 推荐值 | 说明 |
|------|--------|------|
| 广播标准 | -16 dB | 较响 |
| 一般视频 | -18 dB | 中等 |
| 网络视频 | -20 dB | 较安静 |

## 工作原理

```
原始视频:
  片段1: -18 dB (较响)
  片段2: -25 dB (较轻)
  片段3: -20 dB (中等)

↓ 启用音量均衡（平均值策略）

检测结果:
  目标音量: -21 dB

调整后:
  片段1: -18 dB → -21 dB (-3 dB)
  片段2: -25 dB → -21 dB (+4 dB)
  片段3: -20 dB → -21 dB (-1 dB)

↓ 最终效果: 所有片段音量一致
```

## 技术细节

### 检测方法
- FFmpeg `astats` 滤镜
- RMS（均方根）音量
- 精度: dB级别

### 调整方法
- FFmpeg `volume` 滤镜
- 范围: -30 dB ~ +30 dB
- 精度: 0.01 dB

### 处理流程
```
音量检测 → 计算目标 → 计算调整量 → 应用调整
  (2-5秒)   (<1秒)    (<1秒)       (嵌入处理)
```

## 测试结果

✅ **8/8 单元测试通过**
- 平均值策略 ✅
- 中位数策略 ✅
- 固定值策略 ✅
- 边界情况 ✅

## 性能影响

| 视频数量 | 额外时间 |
|---------|---------|
| 5个片段 | ~5秒 |
| 10个片段 | ~10秒 |
| 20个片段 | ~15秒 |

说明: 并发检测，对总时间影响约10-15%

## 常见问题

### Q: 音量均衡会降低音质吗？
A: 调整量较小时（<6 dB）影响很小，调整量大时可能轻微影响。

### Q: 为什么有些视频显示"使用默认值"？
A: 视频没有音频流或检测失败，使用-20 dB默认值。

### Q: 可以只调整部分片段吗？
A: 目前不支持，会调整所有非转场视频。

### Q: 与淡入淡出冲突吗？
A: 不冲突，音量调整在淡入淡出之前。

## 使用技巧

1. **首次使用**: 选择"平均值"策略，最安全
2. **有异常片段**: 使用"中位数"策略
3. **专业需求**: 使用"固定值"策略，设置-16 dB
4. **不确定**: 先不启用，生成后手动试听

## 配置示例

### JavaScript
```javascript
const volumeBalance = {
  enabled: true,
  strategy: 'average',
  targetDb: -16
};
```

### 生成的payload
```json
{
  "volumeBalance": {
    "enabled": true,
    "strategy": "average",
    "targetDb": -16
  }
}
```

## 相关功能

- ✅ 淡入淡出: 完全兼容
- ✅ 转场视频: 完全兼容（转场不调整）
- ✅ 均匀分布标签: 完全兼容

## 文件位置

- **后端**: `apps/desktop/src/main/generator.cjs`
- **前端**: `apps/webui/src/hooks/useGenerator.js`
- **UI**: `apps/webui/src/pages/GeneratorPage.jsx`
- **测试**: `test/volumeBalance.test.js`

## 版本信息

- **版本**: v1.0
- **状态**: ✅ 已完成
- **测试**: ✅ 全部通过
- **文档**: ✅ 完整
- **可用性**: ✅ 可以使用

---

**快速开始**: 勾选"启用音量均衡" → 选择"平均值" → 开始生成 🚀
