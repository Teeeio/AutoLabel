import { useAppContext } from "../context/AppContext";
import { useState, useCallback, useRef, useEffect } from "react";
import CollectionManager from "../components/CollectionManager";

export default function CommunityPage() {
  const app = useAppContext();
  if (!app) return null;

  // æ”¶è—å¤¹è§†å›¾çŠ¶æ€
  const [showFavorites, setShowFavorites] = useState(false);

  // é€‰ä¸­çš„æ”¶è—å¤¹ID
  const [selectedCollectionId, setSelectedCollectionId] = useState(null);

  // æ”¶è—å¤¹ç®¡ç†çŠ¶æ€ï¼ˆç”¨äºåˆ›å»º/ç¼–è¾‘æ”¶è—å¤¹ï¼‰
  const [showCollectionManager, setShowCollectionManager] = useState(false);

  // æ”¶è—å¤¹é€‰æ‹©å™¨çŠ¶æ€ï¼ˆç‚¹å‡»æ”¶è—æŒ‰é’®æ—¶æ˜¾ç¤ºï¼‰
  const [showCollectionSelector, setShowCollectionSelector] = useState(null); // å­˜å‚¨è¦æ“ä½œçš„å¡ç‰‡ID

  // è·Ÿè¸ªæ­£åœ¨æ‹–åŠ¨çš„è¿›åº¦æ¡
  const [draggingCardId, setDraggingCardId] = useState(null);
  const dragStartTimeRef = useRef(null);
  const dragStartXRef = useRef(0);

  // æ›´æ–°è§†é¢‘æ’­æ”¾æ—¶é—´çš„é€šç”¨å‡½æ•°
  const updateVideoTime = useCallback((cardId, newTime) => {
    const webviewId = `community-preview-${cardId}`;
    const webview = document.getElementById(webviewId);

    if (webview) {
      try {
        webview.executeJavaScript(`
          (function() {
            const video = document.querySelector('video');
            if (video) {
              video.currentTime = ${newTime};
              console.log('[Progress] Jumped to time:', ${newTime});
            }
          })();
        `).catch((err) => {
          console.warn('[Progress] Failed to seek video:', err);
        });
      } catch (err) {
        console.warn('[Progress] Failed to execute JavaScript:', err);
      }
    }

    // æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
    app.setPreviewCurrentTime((prev) => new Map(prev).set(cardId, newTime));
  }, [app]);

  // å¤„ç†è¿›åº¦æ¡ç‚¹å‡»/æ‹–åŠ¨å¼€å§‹
  const handleProgressMouseDown = useCallback((card, e) => {
    e.stopPropagation();
    const progressBar = e.currentTarget;
    const rect = progressBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const percentage = Math.max(0, Math.min(1, clickX / rect.width));
    const newTime = card.start + percentage * (card.end - card.start);

    // ç«‹å³è·³è½¬åˆ°ç‚¹å‡»ä½ç½®
    updateVideoTime(card.id, newTime);

    // è®¾ç½®æ‹–åŠ¨çŠ¶æ€
    setDraggingCardId(card.id);
    dragStartTimeRef.current = newTime;
    dragStartXRef.current = e.clientX;
  }, [updateVideoTime]);

  // å¤„ç†æ‹–åŠ¨è¿‡ç¨‹ä¸­çš„ç§»åŠ¨
  const handleMouseMove = useCallback((e) => {
    if (draggingCardId === null) return;

    // æ‰¾åˆ°å¯¹åº”çš„å¡ç‰‡æ•°æ®
    const card = app.communityCardResults.find(c => c.id === draggingCardId);
    if (!card) return;

    // è®¡ç®—æ–°çš„æ—¶é—´
    const progressBar = document.querySelector(`[data-card-id="${draggingCardId}"] .preview-progress-bar`);
    if (!progressBar) return;

    const rect = progressBar.getBoundingClientRect();
    const x = Math.max(0, Math.min(rect.width, e.clientX - rect.left));
    const percentage = x / rect.width;
    const newTime = card.start + percentage * (card.end - card.start);

    // æ›´æ–°è§†é¢‘æ—¶é—´
    updateVideoTime(draggingCardId, newTime);
  }, [draggingCardId, app.communityCardResults, updateVideoTime]);

  // å¤„ç†æ‹–åŠ¨ç»“æŸ
  const handleMouseUp = useCallback(() => {
    if (draggingCardId !== null) {
      setDraggingCardId(null);
      dragStartTimeRef.current = null;
      dragStartXRef.current = 0;
    }
  }, [draggingCardId]);

  // æ·»åŠ å…¨å±€é¼ æ ‡äº‹ä»¶ç›‘å¬
  useEffect(() => {
    if (draggingCardId !== null) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('mouseup', handleMouseUp);

      return () => {
        window.removeEventListener('mousemove', handleMouseMove);
        window.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [draggingCardId, handleMouseMove, handleMouseUp]);

  // è·å–é€‰ä¸­æ”¶è—å¤¹çš„å†…å®¹
  const [selectedCollectionCards, setSelectedCollectionCards] = useState([]);
  const [loadingCollection, setLoadingCollection] = useState(false);

  useEffect(() => {
    if (showFavorites && selectedCollectionId) {
      setLoadingCollection(true);
      import("../collectionApi").then(async ({ getCollectionById }) => {
        try {
          const data = await getCollectionById(selectedCollectionId, app.communitySession?.id);
          if (data.ok) {
            setSelectedCollectionCards(data.collection.cards || []);
          } else {
            setSelectedCollectionCards([]);
          }
        } catch (err) {
          console.error("[Collection] Failed to load collection:", err);
          setSelectedCollectionCards([]);
        } finally {
          setLoadingCollection(false);
        }
      });
    } else {
      setSelectedCollectionCards([]);
    }
  }, [showFavorites, selectedCollectionId, app.communitySession?.id]);

  // å¤„ç†å¡ç‰‡æ”¶è—åˆ°æ”¶è—å¤¹
  const handleAddToCollection = async (cardId, collectionId) => {
    const result = await app.toggleCardInCollection?.(collectionId, cardId);
    if (result.ok) {
      setShowCollectionSelector(null);
    }
  };

  // åˆ›å»ºå¿«é€Ÿæ”¶è—å¤¹
  const handleQuickCreateCollection = async (name) => {
    const result = await app.createCollection?.(name, "", "private");
    if (result.ok && showCollectionSelector) {
      // è‡ªåŠ¨å°†å¡ç‰‡æ·»åŠ åˆ°æ–°æ”¶è—å¤¹
      await handleAddToCollection(showCollectionSelector, result.collection.id);
    }
    return result;
  };

  return (
    <section className="panel panel-community">
      <div className="community-layout">
        <div className="community-header">
          <div>
            <div className="community-title">ç¤¾åŒº</div>
            <div className="community-meta">
              æµè§ˆç¤¾åŒºåˆ†äº«ç‰‡æ®µï¼Œæ‚¬åœé¢„è§ˆã€‚
            </div>
          </div>
          <div className="community-actions">
            {app.communitySession ? (
              <button type="button" className="ghost" onClick={app.handleCommunityLogout}>
                é€€å‡ºç™»å½•
              </button>
            ) : (
              <>
                <button type="button" className="ghost" onClick={app.openCommunityLogin}>
                  ç™»å½•
                </button>
                <button type="button" className="ghost" onClick={app.openCommunityRegister}>
                  æ³¨å†Œ
                </button>
              </>
            )}
          </div>
        </div>

        <div className="community-toolbar">
          <div className="community-tabs">
            <button
              type="button"
              className={"community-tab" + (!showFavorites ? " is-active" : "")}
              onClick={() => {
                setShowFavorites(false);
                setSelectedCollectionId(null);
              }}
            >
              å…¨éƒ¨
            </button>
            <button
              type="button"
              className={"community-tab" + (showFavorites ? " is-active" : "")}
              onClick={() => setShowFavorites(true)}
            >
              æ”¶è—å¤¹
            </button>
          </div>
          <form
            className="community-search"
            onSubmit={(event) => {
              event.preventDefault();
              app.refreshCommunitySearch();
            }}
          >
            <input
              value={app.communitySearchQuery}
              onChange={(event) => app.setCommunitySearchQuery(event.target.value)}
              placeholder="æœç´¢å…¬å¼€å¡ç‰‡"
            />
            <select
              value={app.communitySearchSort}
              onChange={(event) => app.setCommunitySearchSort(event.target.value)}
            >
              <option value="latest">æœ€æ–°</option>
              <option value="hot">çƒ­é—¨</option>
            </select>
            <button type="submit" className="ghost">
              æœç´¢
            </button>
          </form>
          {app.communityStatus.error ? (
            <div className="community-error">{app.communityStatus.error}</div>
          ) : null}
        </div>

        <div className="community-content">
          {showFavorites ? (
            // æ”¶è—å¤¹è§†å›¾ï¼šå·¦ä¾§åˆ—è¡¨ï¼Œå³ä¾§å†…å®¹
            <div className="collection-view">
              {/* å·¦ä¾§æ”¶è—å¤¹åˆ—è¡¨ */}
              <div className="collection-sidebar">
                <div className="collection-sidebar-header">
                  <h3>æˆ‘çš„æ”¶è—å¤¹</h3>
                  <button
                    type="button"
                    className="ghost small"
                    onClick={() => setShowCollectionManager(true)}
                    title="ç®¡ç†æ”¶è—å¤¹"
                  >
                    âš™ï¸
                  </button>
                </div>

                {app.communitySession ? (
                  <div className="collection-list">
                    {app.collections && app.collections.length > 0 ? (
                      // æ’åºï¼šé»˜è®¤æ”¶è—å¤¹åœ¨æœ€å‰é¢ï¼Œç„¶åæŒ‰æ›´æ–°æ—¶é—´é™åº
                      [...app.collections].sort((a, b) => {
                        if (a.isDefault && !b.isDefault) return -1;
                        if (!a.isDefault && b.isDefault) return 1;
                        return (b.updatedAt || 0) - (a.updatedAt || 0);
                      }).map((collection) => (
                        <div
                          key={collection.id}
                          className={"collection-item" + (selectedCollectionId === collection.id ? " is-active" : "")}
                          onClick={() => setSelectedCollectionId(collection.id)}
                        >
                          <div className="collection-item-info">
                            <div className="collection-item-name">
                              {collection.name}
                              {collection.isDefault && (
                                <span className="collection-item-default-badge">é»˜è®¤</span>
                              )}
                            </div>
                            <div className="collection-item-meta">
                              <span className="collection-item-count">
                                {collection.cardIds?.length || 0} ä¸ªå¡ç‰‡
                              </span>
                              <span className={"collection-item-visibility " + collection.visibility}>
                                {collection.visibility === "public" ? "ğŸŒ" : "ğŸ”’"}
                              </span>
                            </div>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="collection-empty-hint">
                        è¿˜æ²¡æœ‰æ”¶è—å¤¹
                        <button
                          type="button"
                          className="ghost small"
                          onClick={() => setShowCollectionManager(true)}
                        >
                          åˆ›å»ºæ”¶è—å¤¹
                        </button>
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="collection-login-hint">
                    ç™»å½•åå¯ä½¿ç”¨æ”¶è—å¤¹
                    <button
                      type="button"
                      className="ghost small"
                      onClick={app.openCommunityLogin}
                    >
                      ç™»å½•
                    </button>
                  </div>
                )}
              </div>

              {/* å³ä¾§æ”¶è—å¤¹å†…å®¹ */}
              <div className="collection-content">
                {selectedCollectionId ? (
                  loadingCollection ? (
                    <div className="collection-loading">åŠ è½½ä¸­...</div>
                  ) : selectedCollectionCards.length > 0 ? (
                    <div className="manage-cards">
                      {selectedCollectionCards.map((card) => {
                        const progress =
                          card.end > card.start
                            ? ((app.previewCurrentTime.get(card.id) || card.start) - card.start) /
                              (card.end - card.start)
                            : 0;
                        const progressPercent = Math.max(0, Math.min(100, progress * 100));
                        const isDragging = draggingCardId === card.id;

                        return (
                          <div
                            key={card.id}
                            className="manage-card"
                            data-card-id={card.id}
                            onClick={() => app.setActiveId && app.setActiveId(card.id)}
                            style={{ cursor: 'pointer' }}
                          >
                            <div className="manage-card-head">
                              <div className="manage-card-head-row">
                                <div className="manage-card-head-left">
                                  <div className="manage-card-info">
                                    <div className="manage-card-title">{card.title || "æœªå‘½åå¡ç‰‡"}</div>
                                    <div
                                      className="save-item-meta"
                                      dangerouslySetInnerHTML={{
                                        __html: `<span class="save-item-duration">â± ${app.formatTime(card.end - card.start)}</span><span class="save-item-source">${card.source === 'local' ? 'ğŸ“ æœ¬åœ°' : 'ğŸµ Bç«™'}</span>`
                                      }}
                                    />
                                  </div>
                                </div>

                                <div className="manage-card-head-right">
                                  <div className={"manage-visibility " + card.visibility}>
                                    {card.visibility === "public" ? "ğŸŒ å…¬å¼€" : "ğŸ”’ ç§æœ‰"}
                                  </div>
                                  <div className="manage-card-actions">
                                    <button
                                      type="button"
                                      className="ghost manage-card-action-btn"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        app.handleToggleCardFavorite(card);
                                      }}
                                      title={app.favoriteCardIds.has(card.id) ? "å–æ¶ˆæ”¶è—" : "æ”¶è—"}
                                    >
                                      {app.favoriteCardIds.has(card.id) ? "â˜…" : "â˜†"}
                                    </button>
                                    <button
                                      type="button"
                                      className="ghost manage-card-action-btn"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        app.handleOpenCardDetail(card);
                                      }}
                                      title="æŸ¥çœ‹è¯¦æƒ…"
                                    >
                                      ğŸ“–
                                    </button>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div
                              className="manage-card-preview"
                              onMouseEnter={() => app.handleCommunityHoverStart(card)}
                              onMouseLeave={() => app.handleCommunityHoverEnd(card)}
                            >
                              <div className="preview-container">
                                {app.webviewCommunityIds.has(card.id) ? (
                                  <>
                                    {card.source === "local" && card.localPath ? (
                                      <app.LocalCardPreview
                                        card={card}
                                        videoId={`community-preview-${card.id}`}
                                        className="card-preview-webview"
                                        muted={false}
                                        isHovered={app.hoveredCommunityId === card.id}
                                        onTimeUpdate={(time) => {
                                          app.setPreviewCurrentTime((prev) => new Map(prev).set(card.id, time));
                                        }}
                                      />
                                    ) : (
                                      <webview
                                        id={`community-preview-${card.id}`}
                                        data-card-id={card.id}
                                        data-bvid={card.bvid}
                                        data-start={card.start}
                                        data-end={card.end}
                                        src={app.buildCardPreviewUrl({
                                          bvid: card.bvid,
                                          start: card.start,
                                          end: card.end
                                        })}
                                        className="card-preview-webview"
                                        allowpopups="true"
                                        httpreferrer="https://www.bilibili.com"
                                        useragent={app.bilibiliUserAgent}
                                        partition="temp:bili"
                                        preload={window.env?.bilibiliPagePreload}
                                        style={{ opacity: 1, width: "100%", height: "100%" }}
                                      />
                                    )}
                                    <div className="preview-bottom-shield" />
                                    <div
                                      className="preview-progress-bar"
                                      onMouseDown={(e) => handleProgressMouseDown(card, e)}
                                      style={{ cursor: isDragging ? 'grabbing' : 'pointer' }}
                                    >
                                      <div className="preview-progress-track" />
                                      <div
                                        className="preview-progress-handle"
                                        style={{
                                          left: `${progressPercent}%`,
                                          cursor: isDragging ? 'grabbing' : 'grab'
                                        }}
                                      />
                                      <div
                                        className="preview-progress-track"
                                        style={{ width: `${progressPercent}%` }}
                                      />
                                    </div>
                                    <div className="preview-range-markers">
                                      <div className="preview-range-marker">
                                        {app.formatTime(
                                          Math.floor(
                                            (app.previewCurrentTime.get(card.id) || card.start) - card.start
                                          )
                                        )}
                                      </div>
                                      <div className="preview-range-marker">
                                        {app.formatTime(Math.floor(card.end - card.start))}
                                      </div>
                                    </div>
                                  </>
                                ) : (
                                  <div className="preview-placeholder">
                                    <div className="preview-placeholder-content">
                                      <div className="preview-placeholder-icon"></div>
                                      <div className="preview-placeholder-text">æ‚¬åœé¢„è§ˆ</div>
                                    </div>
                                  </div>
                                )}
                                {app.communityLoadingState.get(card.id)?.webviewLoading &&
                                app.webviewCommunityIds.has(card.id) &&
                                card.source !== "local" ? (
                                  <div className="preview-overlay">
                                    <div className="preview-overlay-spinner" />
                                  </div>
                                ) : null}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="collection-empty">è¯¥æ”¶è—å¤¹è¿˜æ²¡æœ‰å¡ç‰‡</div>
                  )
                ) : (
                  <div className="collection-empty">
                    {app.communitySession ? "é€‰æ‹©ä¸€ä¸ªæ”¶è—å¤¹æŸ¥çœ‹å†…å®¹" : "ç™»å½•åå¯æŸ¥çœ‹æ”¶è—å¤¹"}
                  </div>
                )}
              </div>
            </div>
          ) : (
            // å…¨éƒ¨å¡ç‰‡è§†å›¾
            <div className="community-list manage-cards">
              {app.communityCardResults.length ? (
                app.communityCardResults.map((card) => {
                const progress =
                  card.end > card.start
                    ? ((app.previewCurrentTime.get(card.id) || card.start) - card.start) /
                      (card.end - card.start)
                    : 0;
                const progressPercent = Math.max(0, Math.min(100, progress * 100));
                const isDragging = draggingCardId === card.id;

                return (
                  <div
                    key={card.id}
                    className="manage-card"
                    data-card-id={card.id}
                    onClick={() => app.setActiveId && app.setActiveId(card.id)}
                    style={{ cursor: 'pointer' }}
                  >
                    <div className="manage-card-head">
                      <div className="manage-card-head-row">
                        <div className="manage-card-head-left">
                          <div className="manage-card-info">
                            <div className="manage-card-title">{card.title || "æœªå‘½åå¡ç‰‡"}</div>
                            <div
                              className="save-item-meta"
                              dangerouslySetInnerHTML={{
                                __html: `<span class="save-item-duration">â± ${app.formatTime(card.end - card.start)}</span><span class="save-item-source">${card.source === 'local' ? 'ğŸ“ æœ¬åœ°' : 'ğŸµ Bç«™'}</span>`
                              }}
                            />
                          </div>
                        </div>

                        <div className="manage-card-head-right">
                          <div className={"manage-visibility " + card.visibility}>
                            {card.visibility === "public" ? "ğŸŒ å…¬å¼€" : "ğŸ”’ ç§æœ‰"}
                          </div>
                          <div className="manage-card-actions">
                            <button
                              type="button"
                              className="ghost manage-card-action-btn"
                              onClick={(e) => {
                                e.stopPropagation();
                                app.handleToggleCardFavorite(card);
                              }}
                              title={app.favoriteCardIds.has(card.id) ? "å–æ¶ˆæ”¶è—" : "æ”¶è—"}
                            >
                              {app.favoriteCardIds.has(card.id) ? "â˜…" : "â˜†"}
                            </button>
                            <button
                              type="button"
                              className="ghost manage-card-action-btn"
                              onClick={(e) => {
                                e.stopPropagation();
                                app.handleOpenCardDetail(card);
                              }}
                              title="æŸ¥çœ‹è¯¦æƒ…"
                            >
                              ğŸ“–
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div
                      className="manage-card-preview"
                      onMouseEnter={() => app.handleCommunityHoverStart(card)}
                      onMouseLeave={() => app.handleCommunityHoverEnd(card)}
                    >
                      <div className="preview-container">
                        {app.webviewCommunityIds.has(card.id) ? (
                          <>
                            {card.source === "local" && card.localPath ? (
                              <app.LocalCardPreview
                                card={card}
                                videoId={`community-preview-${card.id}`}
                                className="card-preview-webview"
                                muted={false}
                                isHovered={app.hoveredCommunityId === card.id}
                                onTimeUpdate={(time) => {
                                  app.setPreviewCurrentTime((prev) => new Map(prev).set(card.id, time));
                                }}
                              />
                            ) : (
                              <webview
                                id={`community-preview-${card.id}`}
                                data-card-id={card.id}
                                data-bvid={card.bvid}
                                data-start={card.start}
                                data-end={card.end}
                                src={app.buildCardPreviewUrl({
                                  bvid: card.bvid,
                                  start: card.start,
                                  end: card.end
                                })}
                                className="card-preview-webview"
                                allowpopups="true"
                                httpreferrer="https://www.bilibili.com"
                                useragent={app.bilibiliUserAgent}
                                partition="temp:bili"
                                preload={window.env?.bilibiliPagePreload}
                                style={{ opacity: 1, width: "100%", height: "100%" }}
                              />
                            )}
                            <div className="preview-bottom-shield" />
                            <div
                              className="preview-progress-bar"
                              onMouseDown={(e) => handleProgressMouseDown(card, e)}
                              style={{ cursor: isDragging ? 'grabbing' : 'pointer' }}
                            >
                              <div className="preview-progress-track" />
                              <div
                                className="preview-progress-handle"
                                style={{
                                  left: `${progressPercent}%`,
                                  cursor: isDragging ? 'grabbing' : 'grab'
                                }}
                              />
                              <div
                                className="preview-progress-track"
                                style={{ width: `${progressPercent}%` }}
                              />
                            </div>
                            <div className="preview-range-markers">
                              <div className="preview-range-marker">
                                {app.formatTime(
                                  Math.floor(
                                    (app.previewCurrentTime.get(card.id) || card.start) - card.start
                                  )
                                )}
                              </div>
                              <div className="preview-range-marker">
                                {app.formatTime(Math.floor(card.end - card.start))}
                              </div>
                            </div>
                          </>
                        ) : (
                          <div className="preview-placeholder">
                            <div className="preview-placeholder-content">
                              <div className="preview-placeholder-icon"></div>
                              <div className="preview-placeholder-text">æ‚¬åœé¢„è§ˆ</div>
                            </div>
                          </div>
                        )}
                        {app.communityLoadingState.get(card.id)?.webviewLoading &&
                        app.webviewCommunityIds.has(card.id) &&
                        card.source !== "local" ? (
                          <div className="preview-overlay">
                            <div className="preview-overlay-spinner" />
                          </div>
                        ) : null}
                      </div>
                    </div>
                  </div>
                );
              })
            ) : (
              <div className="manage-empty">æœªæ‰¾åˆ°ç¤¾åŒºå¡ç‰‡ã€‚</div>
            )}
            </div>
